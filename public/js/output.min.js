function loadGoogleAutocomplete(){setTimeout(function(){var defaultBounds=new google.maps.LatLngBounds(new google.maps.LatLng(-27.641505,153.106308)),options={bounds:defaultBounds},startAddress=new google.maps.places.Autocomplete(document.getElementById("start-address"),options),destAddress=new google.maps.places.Autocomplete(document.getElementById("dest-address"),options);setGoogleListener(startAddress,"start"),setGoogleListener(destAddress,"dest")},1e3)}function setGoogleListener(control,name){google.maps.event.addListener(control,"place_changed",function(){var place=control.getPlace();place.formatted_address;if(!place.geometry)return void console.debug("Google Maps API call returned an empty address, please try to provide an other place");var latitude=place.geometry.location.lat(),longitude=place.geometry.location.lng();getPostalCode(latitude,longitude).then(function(postcode){setAddressDetails(name,latitude,longitude,postcode)},function(err){console.debug("An error occurred during postcode resolution.",err)})}),$("#dest-address").keydown(function(){setAddressDetails("dest","","","")}),$("#start-address").keydown(function(){setAddressDetails("start","","","")})}function setAddressDetails(name,lat,long,postcode){document.getElementById(name+"PostCode").value=postcode,document.getElementById(name+"AddressLat").value=lat,document.getElementById(name+"AddressLong").value=long}function readPostalCode(place){for(var outOfBoundAddress=!1,postcode="",i=0;i<place.address_components.length;i++){var addressType=place.address_components[i].types[0];if("country"===addressType&&"Australia"!==place.address_components[i].long_name){outOfBoundAddress=!0;break}"postal_code"===addressType&&(postcode=place.address_components[i].short_name)}return outOfBoundAddress?"":postcode}function getPostalCode(latitude,longitude){var deferred=$.Deferred(),geocoder=new google.maps.Geocoder;return geocoder.geocode({location:{lat:latitude,lng:longitude}},function(results,status){if(status===google.maps.GeocoderStatus.OK&&results.length>0)for(var i=0;i<results.length;i++){var postcode=readPostalCode(results[i]);if(""!=postcode){deferred.resolve(postcode);break}}""==postcode&&deferred.reject(status)}),deferred.promise()}function validateAddresses(){var startPC=document.getElementById("startPostCode").value,startLat=document.getElementById("startAddressLat").value,startLong=document.getElementById("startAddressLong").value,destPC=document.getElementById("destPostCode").value,destLat=document.getElementById("destAddressLat").value,destLong=document.getElementById("destAddressLong").value,errors=[];return startLat&&startLong&&startPC||errors.push("<li>Start address invalid or not found</li>"),destLat&&destLong&&destPC||errors.push("<li>Destination address invalid or not found</li>"),addressWithinLoganRegion(startPC)||addressWithinLoganRegion(destPC)||errors.push("<li>At this point we require at least one address to be within the Logan city bounds.</li>"),bothAddressesAreIdentical(startLat,startLong,destLat,destLong)&&errors.push("Please enter two different addresses"),errors.length>0?(document.getElementById("validation-errors").innerHTML="There were errors in the information entered: <ul>"+errors.join("")+"</ul>",!1):(document.getElementById("validation-errors").innerText="",!0)}function addressWithinLoganRegion(postcode){return loganPostcodes.indexOf(postcode)>-1}function bothAddressesAreIdentical(startLat,startLong,destLat,destLong){var addressesIdentical=!1;return startLat===destLat&&startLong===destLong&&(addressesIdentical=!0),addressesIdentical}google.maps.event.addDomListener(window,"load",function(){loadGoogleAutocomplete()});var loganPostcodes=["4114","4117","4118","4119","4123","4124","4125","4127","4128","4129","4130","4131","4132","4133","4205","4207","4270","4280","4285"],app=angular.module("bus-meme",["ngRoute"]);app.config(function($routeProvider){$routeProvider.when("/",{templateUrl:"views/main.html",controller:"MapController"}).when("/galleries",{templateUrl:"views/gallery.html",controller:"GalleryController"})}),app.controller("MapController",function($scope,$location,$rootScope,MapService,$anchorScroll){$rootScope.showGallery=function(){$location.path("/galleries")},loadGoogleAutocomplete(),$scope.transport={mode:"driving"},$scope.showImage=!1,$scope.showMap=!1,$scope.origin=null,$scope.destination=null,$scope.ptLatLng=[],$scope.dwLatLng=[],$scope.dwBounds=null,$scope.ptBounds=null,$scope.map=null;var getGoogleRoute=function(mode,startLat,startLng,endLat,endLng){var d=Q.defer(),travelOptions={startLat:startLat,startLng:startLng,destLat:endLat,destLng:endLng},routeDetails={};return MapService.getDirections(travelOptions,mode,function(result,status){if(status==google.maps.DirectionsStatus.OK){routeDetails.distance=result.routes[0].legs[0].distance.text,routeDetails.duration=result.routes[0].legs[0].duration.text;var latLng=[],currentMode="";routeDetails.polylineCoords=[],result.routes.forEach(function(route){route.legs.forEach(function(leg){leg.steps.forEach(function(step){var travelMode=step.travel_mode.toLowerCase();travelMode!==currentMode&&(latLng.length>0&&(routeDetails.polylineCoords.push({mode:currentMode,coords:latLng}),latLng=[]),currentMode=travelMode),step.path.forEach(function(path){latLng.push({lat:path.lat(),lng:path.lng()})})})})}),latLng.length>0&&(routeDetails.polylineCoords.push({mode:currentMode,coords:latLng}),latLng=[]),routeDetails.bounds=result.routes[0].bounds,d.resolve(routeDetails)}else d.resolve(null)}),d.promise},clearStatus=function(){$("#map-status").html("")},addStatus=function(message){$("#map-status").html($("#map-status").html()+"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+message)};$scope.getMapData=function(){if($scope.dwBounds=null,$scope.ptBounds=null,clearStatus(),$("#map-status").show(),addStatus("Building your meme, please be patient"),$("#map-wrapper").show(),$scope["public"]={mode:"public",distance:"",duration:""},$scope.other={mode:$scope.transport.mode,distance:"",duration:""},validateAddresses()){addStatus("Addresses are valid");var startLat=document.getElementById("startAddressLat").value,startLng=document.getElementById("startAddressLong").value,destLat=document.getElementById("destAddressLat").value,destLng=document.getElementById("destAddressLong").value;$scope.origin=new google.maps.LatLng(startLat,startLng),$scope.destination=new google.maps.LatLng(destLat,destLng),addStatus("Retrieving "+$scope.transport.mode+" directions from Google..."),getGoogleRoute($scope.transport.mode,startLat,startLng,destLat,destLng).then(function(dwRoute){return dwRoute?(addStatus("Success!"),$scope.other={mode:$scope.transport.mode,distance:dwRoute.distance,duration:shorter(dwRoute.duration)},$scope.dwLatLng=dwRoute.polylineCoords,$scope.dwBounds=dwRoute.bounds,[!0,!1]):(addStatus("Failed to retrieve directions, please wait a moment and try again"),[!1,!1])}).then(function(dirStatus){var d=Q.defer();dirStatus[0]||d.resolve(dirStatus),addStatus("Retrieving journey information from Translink (allowing 10 sec)...");var tlapiUrl=window.location.href.replace("#","tl/"+startLat+"/"+startLng+"/"+destLat+"/"+destLng+"/"+$scope.getTimeOption()+"/"+$scope.getSelectedTime().getTime()/1e3+"/"+$scope.getMaxWalk());return $.ajax({type:"GET",url:tlapiUrl,timeout:1e4,success:function(journey){journey||(addStatus("Failed to retrieve journey information"),d.resolve(dirStatus)),addStatus("Success!"),$scope["public"]={mode:"public",distance:prettyDistance(journey.walkingDistance),duration:prettyDuration(journey.duration)},$scope.ptLatLng=[],journey.legs&&journey.legs.forEach(function(leg){var legLatLng=[];google.maps.geometry.encoding.decodePath(leg.polyline).forEach(function(ll){legLatLng.push({lat:ll.lat(),lng:ll.lng()})}),$scope.ptLatLng.push({mode:leg.travelMode,coords:legLatLng})}),$scope.ptBounds=findPolylineBounds($scope.ptLatLng),d.resolve([!0,!0])},error:function(err){addStatus("Journey could not be retrieved, trying Google..."),d.resolve(dirStatus)}}),d.promise}).then(function(dirStatus){if(dirStatus[0]){if(!dirStatus[1])return $scope.ptLatLng=[],addStatus("Retrieving journey information from Google..."),getGoogleRoute("transit",startLat,startLng,destLat,destLng).then(function(ptRoute){return ptRoute?(addStatus("Success!"),$scope["public"]={mode:"public",distance:"Walk: "+ptRoute.distance,duration:shorter(ptRoute.duration)},$scope.ptLatLng=ptRoute.polylineCoords,$scope.ptBounds=ptRoute.bounds,!0):(addStatus("Journey could not be retrieved, try walking there instead..."),!1)}).then(function(googleFoundPT){return googleFoundPT?!0:"walking"===$scope.transport.mode?!1:(addStatus("Retrieving walking directions from Google..."),getGoogleRoute("walking",startLat,startLng,destLat,destLng).then(function(ptRoute){return ptRoute?(addStatus("Success!"),$scope["public"]={mode:"public",distance:"Walk: "+ptRoute.distance,duration:shorter(ptRoute.duration)},$scope.ptLatLng=ptRoute.polylineCoords,$scope.ptBounds=ptRoute.bounds,!0):(addStatus("Failed to retrieve walking directions"),!1)}))}).then(function(ptRouteIsValid){$scope.$apply(function(){$scope.mapToImage(ptRouteIsValid)})});$scope.$apply(function(){$scope.mapToImage(!0)})}else addStatus("Sorry, there was an error. PLease try again later")}),initStep2(),scrollToElement("invisible-anchor"),$scope.showMap=!0}else addStatus("Invalid addresses"),$scope.showMap=!1};var renderStaticMap=function(ptRouteIsValid){var gmapsInfo=getMapConversionInfo(),staticMapsUrl="https://maps.googleapis.com/maps/api/staticmap?",mapCenter="center="+$scope.center.lat()+","+$scope.center.lng(),zoomLevel="zoom="+$scope.zoom,mapSize="size="+$scope.mapWidth+"x"+$scope.mapWidth,imgUrl=staticMapsUrl+mapCenter+"&"+zoomLevel+"&"+mapSize;console.log(imgUrl);var image=document.getElementById("img-out");image.setAttribute("crossorigin","anonymous"),image.setAttribute("src",imgUrl),$("#img-out").show(),$("#img-out").load(function(){var canvas=document.getElementById("canvas"),context=canvas.getContext("2d");$rootScope.context=context,canvas.width=image.width,canvas.height=1.25*image.height,context.drawImage(image,0,0,canvas.width,image.height);var lineWidth=2,ptRouteColor="#FF0000",otherRouteColor="#0000FF",markerColor="#006400",marker2Color="#FF0000";drawCircleAt($scope.origin,context,markerColor,gmapsInfo),drawCircleAt($scope.destination,context,marker2Color,gmapsInfo),ptRouteIsValid&&drawPolylines($scope.ptLatLng,context,lineWidth,ptRouteColor,gmapsInfo),drawPolylines($scope.dwLatLng,context,lineWidth,otherRouteColor,gmapsInfo),drawLegend(context,gmapsInfo,image.height,canvas.width,canvas.height-image.height,image.height),drawMapSummary(context,ptRouteIsValid,image.width/2,image.height+20,ptRouteColor,otherRouteColor,markerColor),$("#gmap-canvas").html(""),$("#map-status").hide(),$("#img-out").hide(),$("#map-wrapper").hide()})};$scope.mapToImage=function(ptRouteIsValid){$scope.mapWidth=600,ptRouteIsValid?$scope.bounds=getCombinedBounds([$scope.ptBounds,$scope.dwBounds]):$scope.bounds=getCombinedBounds([$scope.dwBounds]),$scope.center=$scope.bounds.getCenter(),$scope.zoom=getZoom($scope.bounds,$scope.mapWidth);var mapOptions={zoom:$scope.zoom,center:$scope.center,mapTypeId:google.maps.MapTypeId.ROADMAP};$("#map-wrapper").show(),$scope.map=new google.maps.Map(document.getElementById("gmap-canvas"),mapOptions),google.maps.event.addListenerOnce($scope.map,"idle",function(){$scope.map.getZoom()!=$scope.zoom?(google.maps.event.addListenerOnce($scope.map,"zoom_changed",function(){renderStaticMap(ptRouteIsValid)}),$scope.map.setZoom($scope.zoom)):renderStaticMap(ptRouteIsValid)})};var writeTextOnImage=function(context,lineWidth,text,x,y){for(var f=36;f>=0;f-=1)if(context.font="bold "+f+"pt Impact, Charcoal, sans-serif",context.measureText(text).width<canvas.width-10){context.textAlign="center",context.fillStyle="white",context.strokeStyle="black",context.lineWidth=lineWidth,context.fillText(text,x,y),context.strokeText(text,x,y);break}},drawLegend=function(context,gmapsInfo,yStart,width,height,imageHeight){var lineHeight=3;context.beginPath(),context.rect(1,0,width-2,yStart),context.strokeStyle="#000000",context.lineWidth=lineHeight,context.stroke(),context.beginPath(),context.rect(1,yStart,width-2,height-1),context.fillStyle="#E8E5DC",context.fill(),context.strokeStyle="#000000",context.lineWidth=lineHeight,context.stroke()},drawMapSummary=function(context,ptRouteIsValid,x,y,ptColour,otherColour,walkingColour){var fontStyle="Helvetica",fontReg="16px ",fontHdr="bold 16px ",fontStyle="Helvetica";context.font=fontReg+fontStyle,context.textAlign="center",context.fillStyle="black",context.lineHeight=18,context.fillText(getUserTimeSelectionHeader(),x,y),context.font=fontHdr+fontStyle,context.fillText(getOtherModeHeader(),x,y+25),context.font=fontReg+fontStyle,context.fillText(getOtherModeSummary(),x,y+45),context.font=fontHdr+fontStyle,context.fillText("PUBLIC TRANSPORT:",x,y+70),context.font=fontReg+fontStyle,context.fillText(getPublicTransportSummary(ptRouteIsValid),x,y+90),drawMapSummaryLegends(context,x,y+110,ptColour,otherColour,walkingColour)},drawMapSummaryLegends=function(context,x,legendsY,ptColour,otherColour,walkingColour){context.font="14px Helvetica",context.textAlign="left";var legendText="public transport",lineWidth=25,nextLegendIndex=25;drawSummaryLegend(context,nextLegendIndex,legendsY,nextLegendIndex+lineWidth,legendsY,[],ptColour,3),context.fillText(legendText,nextLegendIndex+35,legendsY+5),nextLegendIndex=170+context.measureText(legendText).width,drawSummaryLegend(context,nextLegendIndex,legendsY,nextLegendIndex+lineWidth,legendsY,[5],walkingColour,4),legendText="walking",context.fillText(legendText,nextLegendIndex+35,legendsY+5),nextLegendIndex=170+nextLegendIndex+context.measureText(legendText).width,drawSummaryLegend(context,nextLegendIndex,legendsY,nextLegendIndex+lineWidth,legendsY,[],otherColour,3),legendText="driving",context.fillText(legendText,nextLegendIndex+35,legendsY+5)},drawSummaryLegend=function(context,startX,startY,endX,endY,lineDash,lineColour,lineWidth){context.beginPath(),context.moveTo(startX,startY),context.lineTo(endX,endY),context.setLineDash(lineDash),context.strokeStyle=lineColour,context.lineWidth=lineWidth,context.stroke()},getUserTimeSelectionHeader=function(){console.log($scope.getTimeOption());var transportChoice=$scope.formattedTimeOption(),date=$scope.formattedDate();return transportChoice+" on "+date},getPublicTransportSummary=function(ptRouteIsValid){if(ptRouteIsValid){var duration="Total time: "+$scope["public"].duration+"  ",distance="Total walking distance: "+$scope["public"].distance.replace("Walk: ","");return duration+"  "+distance}return"No Service Available!!"},getOtherModeHeader=function(){return $scope.other.mode.toUpperCase()+":"},getOtherModeSummary=function(){var duration="Total time: "+$scope.other.duration,distance="Total distance: "+$scope.other.distance;return duration+"  "+distance},drawCircleAt=function(center,context,color,gmapsInfo){context.beginPath(),context.strokeStyle=color,context.lineWidth=5;var centerXy=getXYcoords(gmapsInfo,center);context.arc(centerXy[0],centerXy[1],8,0,2*Math.PI),context.stroke()},drawPolylines=function(polylineData,context,lineWidth,lineColor,gmapsInfo){polylineData.forEach(function(polyline){var latLngArray=polyline.coords,startCoords=getXYcoords(gmapsInfo,new google.maps.LatLng(latLngArray[0].lat,latLngArray[0].lng));for(context.beginPath(),context.moveTo(startCoords[0],startCoords[1]),i=1;i<latLngArray.length;i++){var coord=getXYcoords(gmapsInfo,new google.maps.LatLng(latLngArray[i].lat,latLngArray[i].lng));context.lineTo(coord[0],coord[1])}"walking"==polyline.mode?(context.setLineDash([5]),context.strokeStyle="#006400",context.lineWidth=4):(context.setLineDash([]),context.strokeStyle=lineColor,context.lineWidth=lineWidth),context.stroke()})};$scope.renderMemeFinal=function(){var context=$rootScope.context,image=document.getElementById("img-out"),topText=$rootScope.selectedTemplate.firstLine,bottomText=$rootScope.selectedTemplate.secondLine,width=image.width,height=image.height;context.textAlign="center",context.fillStyle="white",context.strokeStyle="black";var lineWidth=2;writeTextOnImage(context,lineWidth,topText,width/2,70),writeTextOnImage(context,lineWidth,bottomText,width/2,height-30),$("canvas2").remove(),$rootScope.memeText=$rootScope.selectedTemplate.firstLine+" - "+$rootScope.selectedTemplate.secondLine};var getZoom=function(bounds,mapWidth){function _latRad(lat){var sin=Math.sin(lat*Math.PI/180),radX2=Math.log((1+sin)/(1-sin))/2;return Math.max(Math.min(radX2,Math.PI),-Math.PI)/2}function _zoom(mapPx,worldPx,fraction){return Math.floor(Math.log(mapPx/worldPx/fraction)/Math.LN2)}var WORLD_DIM={height:256,width:256},ZOOM_MAX=21,ne=bounds.getNorthEast(),sw=bounds.getSouthWest(),latFraction=(_latRad(ne.lat())-_latRad(sw.lat()))/Math.PI,lngDiff=ne.lng()-sw.lng(),lngFraction=(0>lngDiff?lngDiff+360:lngDiff)/360,latZoom=_zoom(mapWidth,WORLD_DIM.height,latFraction),lngZoom=_zoom(mapWidth,WORLD_DIM.width,lngFraction);return Math.min(latZoom,lngZoom,ZOOM_MAX)},getCombinedBounds=function(bounds){for(var bBounds=bounds[0],i=1;i<bounds.length;i++)bBounds.extend(bounds[i].getNorthEast()),bBounds.extend(bounds[i].getSouthWest());return bBounds},getMapConversionInfo=function(){var projection=$scope.map.getProjection(),bounds=$scope.map.getBounds(),topRight=projection.fromLatLngToPoint(bounds.getNorthEast()),bottomLeft=projection.fromLatLngToPoint(bounds.getSouthWest()),topLeft=new google.maps.Point(bottomLeft.x,topRight.y),projectedWidth=topRight.x-bottomLeft.x,projectedHeight=bottomLeft.y-topRight.y,container=document.getElementById("gmap-canvas"),xScale=parseInt(container.offsetWidth)/projectedWidth,yScale=parseInt(container.offsetHeight)/projectedHeight;return{xScale:xScale,yScale:yScale,origin:topLeft,projection:projection,width:container.offsetWidth}},getXYcoords=function(mapInfo,latLng){var worldPoint=mapInfo.projection.fromLatLngToPoint(latLng);return[(worldPoint.x-mapInfo.origin.x)*mapInfo.xScale,(worldPoint.y-mapInfo.origin.y)*mapInfo.yScale]},findPolylineBounds=function(polylineData){if(polylineData[0]){var latMax=polylineData[0].coords[0].lat,lngMax=polylineData[0].coords[0].lng,latMin=polylineData[0].coords[0].lat,lngMin=polylineData[0].coords[0].lng;polylineData.forEach(function(polyline){for(var coords=polyline.coords,i=0;i<polyline.length;i++)coords[i].lat>latMax&&(latMax=coords[i].lat),coords[i].lat<latMin&&(latMin=coords[i].lat),coords[i].lng>lngMax&&(lngMax=coords[i].lng),coords[i].lng<lngMin&&(lngMin=coords[i].lng)});var boundingRect=new google.maps.LatLngBounds(new google.maps.LatLng(latMin,lngMin),new google.maps.LatLng(latMax,lngMax)),center=boundingRect.getCenter(),d2sw=getLatLonDistanceInKm(center.lat(),center.lng(),latMin,lngMin),bounds=getSquareBoundingBox(center,d2sw+.2);return bounds}},getLatLonDistanceInKm=function(lat1,lon1,lat2,lon2){var deg2rad=function(deg){return deg*(Math.PI/180)},R=6371,dLat=deg2rad(lat2-lat1),dLon=deg2rad(lon2-lon1),a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),d=R*c;return d},getSquareBoundingBox=function(centerPoint,distance){var MIN_LAT,MAX_LAT,MIN_LNG,MAX_LNG,R,radDist,degLat,degLon,radLat,radLon,minLat,maxLat,minLon,maxLon,deltaLon;Number.prototype.degToRad=function(){return this*(Math.PI/180)},Number.prototype.radToDeg=function(){return 180*this/Math.PI},MIN_LAT=(-90).degToRad(),MAX_LAT=90..degToRad(),MIN_LNG=(-180).degToRad(),MAX_LNG=180..degToRad(),R=6378.1,radDist=distance/R,degLat=centerPoint.lat(),degLon=centerPoint.lng(),radLat=degLat.degToRad(),radLon=degLon.degToRad(),minLat=radLat-radDist,maxLat=radLat+radDist,minLon=void 0,maxLon=void 0,deltaLon=Math.asin(Math.sin(radDist)/Math.cos(radLat)),minLat>MIN_LAT&&MAX_LAT>maxLat?(minLon=radLon-deltaLon,maxLon=radLon+deltaLon,MIN_LNG>minLon&&(minLon+=2*Math.PI),maxLon>MAX_LNG&&(maxLon-=2*Math.PI)):(minLat=Math.max(minLat,MIN_LAT),maxLat=Math.min(maxLat,MAX_LAT),minLon=MIN_LNG,maxLon=MAX_LNG);var boundingSquare=new google.maps.LatLngBounds(new google.maps.LatLng(minLat.radToDeg(),minLon.radToDeg()),new google.maps.LatLng(maxLat.radToDeg(),maxLon.radToDeg()));return boundingSquare},shorter=function(duration){return duration.replace("Hour","Hr")},prettyDistance=function(distance){return 1e3>distance?"Walk: "+distance+" m":"Walk: "+Math.round(distance/100)/10+" Km"},prettyDuration=function(duration){var mins=duration%60,hrs=(duration-mins)/60,mString="";return mins>1?mString=mins+" Mins":1==mins&&(mString=mins+" Min"),hrs>1?hrs+" Hrs "+mString:1==hrs?hrs+" Hr "+mString:mString};$scope.shareImage=function(){document.getElementById("meme-validation").innerText="",console.log("share"),$rootScope.selectedTemplate?(document.getElementById("map-results").classList.add("done"),$scope.renderMemeFinal(),$scope.showImage=!0,$rootScope.memeShared=!0,scrollToElement("invisible-map-anchor")):document.getElementById("meme-validation").innerText="Please choose a meme template to create your meme"};var initStep2=function(){$rootScope.memeShared=!1,document.getElementById("step-1").classList.add("done"),document.getElementById("summary-from").innerText=document.getElementById("start-address").value,document.getElementById("summary-to").innerText=document.getElementById("dest-address").value},scrollToElement=function(id){setTimeout(function(){$anchorScroll(id)},10)}}),app.factory("MapService",function(){return{getDirections:function(travelOptions,mode,callback){var directionsService=new google.maps.DirectionsService,start=new google.maps.LatLng(travelOptions.startLat,travelOptions.startLng),end=new google.maps.LatLng(travelOptions.destLat,travelOptions.destLng),request={origin:start,destination:end};switch(mode){case"driving":request.travelMode=google.maps.TravelMode.DRIVING;break;case"walking":request.travelMode=google.maps.TravelMode.WALKING;break;default:request.travelMode=google.maps.TravelMode.TRANSIT}directionsService.route(request,callback)}}});var app=angular.module("bus-meme");app.controller("MemeController",function($scope,$rootScope,$location,MemeFactory,$anchorScroll){function writeTextOnImage(context,text,x,y){for(var f=36;f>=0;f-=1)if(context.font="bold "+f+"pt Impact, Charcoal, sans-serif",context.measureText(text).width<canvas.width-10){context.fillText(text,x,y),context.strokeText(text,x,y);break}}$scope.showTemplates=!0,MemeFactory.getMemeTemplates().then(function(response){$scope.memeTemplates=response.data,$rootScope.selectedTemplate="",$scope.memeTemplates=response.data}),$scope.handleOverlay=function(){$rootScope.memeShared||($scope.showTemplates=!0,document.getElementById("templates").className="template-selection",document.getElementById("map-overlay").className="map-overlay")},$scope.setSelectedTemplate=function(template){document.getElementById("meme-validation").innerText="",$rootScope.selectedTemplate=template,$scope.renderMemeTemplate(),$scope.showTemplates=!1},$scope.renderMemeTemplate=function(){$("#canvas2").remove(),$("<canvas>",{id:"canvas2"}).insertAfter($("#canvas"));var canvas=document.getElementById("canvas2"),context=canvas.getContext("2d"),image=document.getElementById("img-out");canvas.width=image.width,canvas.height=image.height;var topText=$rootScope.selectedTemplate.firstLine,bottomText=$rootScope.selectedTemplate.secondLine;context.textAlign="center",context.fillStyle="white",context.strokeStyle="black",context.lineWidth=2,writeTextOnImage(context,topText,canvas.width/2,70),writeTextOnImage(context,bottomText,canvas.width/2,canvas.height-30)}}),app.factory("MemeFactory",["$http",function($http){return{getMemeTemplates:function(){return $http.get("/getMemeTemplates")},saveImageDetails:function(imageDetails){return $http.post("/saveImage",{data:imageDetails})},getImages:function(){return $http.get("/getImages")},saveUserDetails:function(userDetails){return $http.post("/saveUser",{data:userDetails})}}}]);var app=angular.module("bus-meme");app.controller("TimeController",function($scope,$rootScope){function getSevenDays(){days=[];var date=new Date;days.push({label:"Today ("+weekdays[date.getDay()]+")",dateValue:new Date(date)});for(var i=0;6>i;i++)date.setDate(date.getDate()+1),days.push({label:getDateDisplayLabel(date),dateValue:new Date(date)});return days}function getHours(){for(var hours=[],i=1;12>=i;i++)hours.push(i);return hours}function getMinutes(){for(var minutes=[],i=0;12>i;i++){var thisMinute=5*i;60==thisMinute&&(thisMinute=0),minutes.push(twoDigits(thisMinute))}return minutes}function setSelectedTime(){var date=new Date,hour=date.getHours(),roundedMinute=5*Math.ceil(date.getMinutes()/5);60==roundedMinute&&(roundedMinute=0,hour++),$scope.selectedAmpm=$scope.ampms[0],hour>12&&(hour-=12,$scope.selectedAmpm=$scope.ampms[1]),0==hour&&(hour=12,$scope.selectedAmpm=$scope.ampms[0]),$scope.selectedMinute=$scope.minutes[roundedMinute/5],$scope.selectedHour=$scope.hours[hour-1]}function twoDigits(digit){return 10>digit?"0"+digit.toString():digit.toString()}function getDateDisplayLabel(date){return weekdays[date.getDay()].substr(0,3)+" "+date.getDate()+" "+months[date.getMonth()]+" "+date.getFullYear()}function getWalkingOptions(){var walkingOptions=[{label:"Up to 100m",value:"100"},{label:"Up to 250m",value:"250"},{label:"Up to 500m",value:"500"},{label:"Up to 1km",value:"1000"},{label:"Up to 1.5km",value:"1500"},{label:"Up to 2km",value:"2000"},{label:"Up to 4km",value:"4000"}];return walkingOptions}var weekdays=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];$scope.ampms=["am","pm"],$scope.days=getSevenDays(),$scope.selectedDate=$scope.days[0],$scope.hours=getHours(),$scope.minutes=getMinutes(),$scope.walkingOptions=getWalkingOptions(),setSelectedTime(),$scope.timeOption="after",$scope.selectedMaxWalk=$scope.walkingOptions[4],$rootScope.getMaxWalk=function(){return $scope.selectedMaxWalk.value},$rootScope.getTimeOption=function(){return $scope.timeOption},$rootScope.formattedTimeOption=function(){var time=$scope.selectedHour+":"+$scope.selectedMinute+$scope.selectedAmpm;switch($scope.getTimeOption()){case"before":return"Arriving Before "+time;case"after":return"Leaving After "+time;case"first":return"First Service";case"last":return"Last Service"}},$rootScope.formattedDate=function(){var date=$scope.selectedDate.dateValue;return weekdays[date.getDay()].substr(0,3)+" "+date.getDate()+" "+months[date.getMonth()]+" "+date.getFullYear()},$rootScope.getSelectedTime=function(){var hour=$scope.selectedHour;"pm"==$scope.selectedAmpm&&(hour+=12);var date=new Date($scope.selectedDate.dateValue.getFullYear(),$scope.selectedDate.dateValue.getMonth(),$scope.selectedDate.dateValue.getDate(),hour,$scope.selectedMinute,0,0);return date}});var app=angular.module("bus-meme");app.controller("GalleryController",function($scope,$location,MemeFactory){$scope.images=[],$scope.travelMode={driving:!0,walking:!0},$scope.sortOption="biggestDifference";var ITEMS_PER_PAGE=12;MemeFactory.getImages().then(function(response){$scope.images=response.data,$scope.images.forEach(function(image){image.imageUrl="/image/"+image.imageLink})}),$scope.showHomePage=function(){$location.path("")},$scope.formatDistance=function(distance){if(1e3>distance)return distance+"m";var distanceInKm=distance/1e3;return distanceInKm+"km"},$scope.formatTravelTime=function(time){var timeInMinutes=time/6e4;if(60>timeInMinutes)return timeInMinutes+" mins";var hours=(timeInMinutes/60).toFixed(0),minutesLeft=timeInMinutes-60*hours;return hours+" hrs "+minutesLeft+" mins"},$scope.getSortingCriteria=function(sortOption){return"biggestDifference"===sortOption?"(otherModeTravelTime / publicModeTravelTime)":"-"+sortOption},$scope.getDateDisplay=function(dbDate){var date=new Date(dbDate),months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return date.getDate()+" "+months[date.getMonth()]+" "+date.getFullYear()},$scope.itemsPerPage=ITEMS_PER_PAGE,$scope.currentPage=0,$scope.prevPage=function(){$scope.currentPage>0&&$scope.currentPage--},$scope.prevPageDisabled=function(){return 0===$scope.currentPage?"disabled":""},$scope.pageCount=function(){return Math.ceil($scope.images.length/$scope.itemsPerPage)},$scope.range=function(){var range=[];for(i=0;i<$scope.pageCount();i++)range.push(i);return range},$scope.setPage=function(n){0>n||n>$scope.pageCount()||($scope.currentPage=n)},$scope.nextPage=function(){$scope.currentPage<$scope.pageCount()-1&&$scope.currentPage++},$scope.nextPageDisabled=function(){return $scope.currentPage===$scope.pageCount()-1?"disabled":""}}),app.filter("transportMode",function(){return function(images,travelMode){return images.length>0?images.filter(function(image){return"driving"===image.otherMode&&travelMode.driving?!0:"walking"===image.otherMode&&travelMode.walking?!0:void 0}):images}}),app.filter("offset",function(){return function(input,start){return start=parseInt(start,10),input.slice(start)}});var app=angular.module("bus-meme");app.controller("SocialMediaController",function($scope,$rootScope,$location,$route,MemeFactory){function convertToMiliseconds(travelTime){var timeArray=travelTime.split(" ");return moment.duration({hours:timeArray.length>2?timeArray[0]:0,minutes:2===timeArray.length?timeArray[0]:timeArray[0]}).asMilliseconds()}function convertToMeters(distance){return Number(distance.replace(" km",""))*KM_TO_METER_FACTOR}function validEmail(email){return/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+$/.test(email)}function validUser(user){return user.fullName&&user.email?validEmail(user.email):void 0}var KM_TO_METER_FACTOR=1e3,HASH_TAG=" %23publictransportfail";$scope.user={},$scope.invalidUserInput=!1,$scope.downloadCanvas=function(){var canvas=document.getElementById("canvas");$rootScope.imageUrl=canvas.toDataURL("image/png");document.getElementById("dl")},$scope.saveImage=function(callback){if($rootScope.imageLink)callback($rootScope.imageLink);else{$scope.downloadCanvas();var imageDetails={imageUrl:$rootScope.imageUrl,otherMode:$scope.other.mode,otherModeTravelTime:convertToMiliseconds($scope.other.duration),otherModeTravelDistance:convertToMeters($scope.other.distance),publicModeTravelTime:convertToMiliseconds($scope["public"].duration),publicModeTravelDistance:convertToMeters($scope["public"].distance),user:$scope.user};MemeFactory.saveImageDetails(imageDetails).then(function(response){var baseUrl=$location.absUrl().replace("#/",""),imageLink=encodeURIComponent(response.data.imageLink);$rootScope.imageLink=baseUrl+"image/"+imageLink,callback($rootScope.imageLink)})}},$scope.facebookShare=function(){$scope.saveImage(function(imageLink){window.open("https://www.facebook.com/sharer/sharer.php?u="+imageLink+"&t="+$rootScope.memeText+HASH_TAG,"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600")})},$scope.twitterShare=function(){$scope.saveImage(function(imageLink){var tweetLength=140,tweetText=$rootScope.memeText,urlLength=80;tweetText.length+urlLength+HASH_TAG.length>tweetLength&&(tweetText=tweetText.substring(0,tweetLength-HASH_TAG.length-urlLength-2)+".."),tweetText+=HASH_TAG,window.open("https://twitter.com/intent/tweet?text="+tweetText+"&url="+imageLink,"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600")})},$scope.reloadPage=function(){$route.reload()},$scope.saveUserDetails=function(){$scope.invalidUserInput=!validUser($scope.user),$scope.invalidUserInput||MemeFactory.saveUserDetails($scope.user).then(function(response){console.log(response.data)})}});