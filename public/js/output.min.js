function loadGoogleAutocomplete(){setTimeout(function(){var defaultBounds=new google.maps.LatLngBounds(new google.maps.LatLng(-27.641505,153.106308)),options={bounds:defaultBounds},startAddress=new google.maps.places.Autocomplete(document.getElementById("start-address"),options),destAddress=new google.maps.places.Autocomplete(document.getElementById("dest-address"),options);setGoogleListener(startAddress,"start"),setGoogleListener(destAddress,"dest")},1e3)}function setGoogleListener(control,name){google.maps.event.addListener(control,"place_changed",function(){var place=control.getPlace();place.formatted_address;if(!place.geometry)return void console.error("Google Maps API call returned an empty address, please try to provide an other place");var latitude=place.geometry.location.lat(),longitude=place.geometry.location.lng();getPostalCode(latitude,longitude).then(function(postcode){setAddressDetails(name,latitude,longitude,postcode)},function(err){console.error("An error occurred during postcode resolution.",err)})}),$("#dest-address").keydown(function(){setAddressDetails("dest","","","")}),$("#start-address").keydown(function(){setAddressDetails("start","","","")})}function setAddressDetails(name,lat,long,postcode){document.getElementById(name+"PostCode").value=postcode,document.getElementById(name+"AddressLat").value=lat,document.getElementById(name+"AddressLong").value=long}function readPostalCode(place){for(var i=0;i<place.address_components.length;i++){var addressType=place.address_components[i].types[0];if("postal_code"==addressType)return place.address_components[i].short_name}return""}function getPostalCode(latitude,longitude){var deferred=$.Deferred(),geocoder=new google.maps.Geocoder;return geocoder.geocode({location:{lat:latitude,lng:longitude}},function(results,status){if(status===google.maps.GeocoderStatus.OK&&results.length>0)for(var i=0;i<results.length;i++){var postcode=readPostalCode(results[i]);if(""!=postcode){deferred.resolve(postcode);break}}""==postcode&&deferred.reject(status)}),deferred.promise()}function validateAddresses(){var startPC=document.getElementById("startPostCode").value,startLan=document.getElementById("startAddressLat").value,startLong=document.getElementById("startAddressLong").value,destPC=document.getElementById("destPostCode").value,destLat=document.getElementById("destAddressLat").value,destLong=document.getElementById("destAddressLong").value,errors=[];return startLan&&startLong&&startPC||errors.push("<li>Start address invalid or not found</li>"),destLat&&destLong&&destPC||errors.push("<li>Destination address invalid or not found</li>"),addressWithinLoganRegion(startPC)||addressWithinLoganRegion(destPC)||errors.push("<li>At this point we require at least one address to be within the Logan city bounds.</li>"),errors.length>0?(document.getElementById("validation-errors").innerHTML="There were errors in the information entered: <ul>"+errors.join("")+"</ul>",!1):(document.getElementById("validation-errors").innerText="",!0)}function addressWithinLoganRegion(postcode){return loganPostcodes.indexOf(postcode)>-1}function getMapConversionInfo(_map){var projection=_map.getProjection(),bounds=_map.getBounds(),topRight=projection.fromLatLngToPoint(bounds.getNorthEast()),bottomLeft=projection.fromLatLngToPoint(bounds.getSouthWest()),topLeft=new google.maps.Point(bottomLeft.x,topRight.y),width_pr=topRight.x-bottomLeft.x,height_pr=bottomLeft.y-topRight.y,container=document.getElementById("gmap_canvas"),x_scale=parseInt(container.offsetWidth)/width_pr,y_scale=parseInt(container.offsetHeight)/height_pr;return{xScale:x_scale,yScale:y_scale,origin:topLeft,projection:projection}}function getXYcoords(mapInfo,latLng){var worldPoint=mapInfo.projection.fromLatLngToPoint(latLng);return[(worldPoint.x-mapInfo.origin.x)*mapInfo.xScale,(worldPoint.y-mapInfo.origin.y)*mapInfo.yScale]}function testPixelGettering(map){google.maps.event.addListenerOnce(map,"projection_changed",function(){var startLat=document.getElementById("startAddressLat").value,startLng=document.getElementById("startAddressLong").value,destLat=document.getElementById("destAddressLat").value,destLng=document.getElementById("destAddressLong").value,mapConversionInfo=getMapConversionInfo(map),bounds=map.getBounds(),topRight=getXYcoords(mapConversionInfo,bounds.getNorthEast()),bottomLeft=getXYcoords(mapConversionInfo,bounds.getSouthWest()),origin_px=getXYcoords(mapConversionInfo,new google.maps.LatLng(startLat,startLng)),destination_px=getXYcoords(mapConversionInfo,new google.maps.LatLng(destLat,destLng));console.log("Origin:",origin_px,"Destination",destination_px,"TR:",topRight,"BL:",bottomLeft)})}google.maps.event.addDomListener(window,"load",function(){loadGoogleAutocomplete()});var loganPostcodes=["4114","4117","4118","4119","4123","4124","4125","4127","4128","4129","4130","4131","4132","4133","4205","4207","4270","4280","4285"],app=angular.module("bus-meme",["ngRoute"]);app.config(function($routeProvider){$routeProvider.when("/",{templateUrl:"views/main.html",controller:"MapController"}).when("/galleries",{templateUrl:"views/gallery.html",controller:"GalleryController"})}),app.controller("MapController",function($scope,$location,$rootScope,MapService,$anchorScroll){function initStep2(){document.getElementById("step-1").classList.add("done"),document.getElementById("summary-from").innerText=document.getElementById("start-address").value,document.getElementById("summary-to").innerText=document.getElementById("dest-address").value}function scrollToElement(id){setTimeout(function(){$anchorScroll(id)},10)}$rootScope.showGallery=function(){$location.path("/galleries")},loadGoogleAutocomplete(),$scope.transport={mode:"driving"},$scope.showImage=!1,$scope.showMap=!1,$scope.transitDirectionsPolyline="",$scope.drivingOrWalkingDirectionsPolyline="",$scope.origin="",$scope.destination="";var bothResultsFound=function(){return""!==$scope.transitDirectionsPolyline&&""!==$scope.drivingOrWalkingDirectionsPolyline};$scope.getMapData=function(){if(console.log(validateAddresses(),$scope.showMap),validateAddresses()){console.log("validation passed");var startLat=document.getElementById("startAddressLat").value,startLng=document.getElementById("startAddressLong").value,destLat=document.getElementById("destAddressLat").value,destLng=document.getElementById("destAddressLong").value,travelOptions={startLat:startLat,startLng:startLng,destLat:destLat,destLng:destLng};$scope.origin=startLat+","+startLng,$scope.destination=destLat+","+destLng,MapService.getDirections(travelOptions,"public",function(result,status){status==google.maps.DirectionsStatus.OK&&($scope.$apply(function(){$scope["public"]={mode:"public",distance:result.routes[0].legs[0].distance.text,duration:result.routes[0].legs[0].duration.text}}),document.getElementById("public-duration").innerText=$scope["public"].duration,$scope.transitDirectionsPolyline=result.routes[0].overview_polyline,$scope.transitBounds=result.routes[0].bounds,$scope.exportAsImage())}),MapService.getDirections(travelOptions,$scope.transport.mode,function(result,status){status==google.maps.DirectionsStatus.OK&&($scope.$apply(function(){$scope.other={mode:$scope.transport.mode,distance:result.routes[0].legs[0].distance.text,duration:result.routes[0].legs[0].duration.text}}),document.getElementById("other-duration").innerText=$scope.other.duration,$scope.drivingOrWalkingDirectionsPolyline=result.routes[0].overview_polyline,$scope.drivingOrWalkingBounds=result.routes[0].bounds,$scope.exportAsImage())}),initStep2(),scrollToElement("invisible-anchor"),$scope.showMap=!0}else $scope.showMap=!1};var getZoom=function(bounds,mapWidth){var GLOBE_WIDTH=256,west=bounds.getSouthWest().lng(),east=bounds.getNorthEast().lng(),angle=east-west;return 0>angle&&(angle+=360),Math.round(Math.log(360*mapWidth/angle/GLOBE_WIDTH)/Math.LN2)-1};$scope.exportAsImage=function(){var mapWidth=600;if(bothResultsFound()){var bounds=getBoundsCoveringBoth($scope.transitBounds,$scope.drivingOrWalkingBounds),center=bounds.getCenter(),zoom=getZoom(bounds,mapWidth),staticMapsUrl="https://maps.googleapis.com/maps/api/staticmap?scale=1&",startMarker="markers=color:0x80da40ff|label:A|"+$scope.origin,endMarker="markers=color:0xf76255ff|label:B|"+$scope.destination,mapCenter="center="+center.lat()+","+center.lng(),zoomLevel=NaN+zoom,mapSize="size="+mapWidth+"x"+mapWidth,transitPath="path=color:0xff0000ff|weight:4|enc:"+$scope.transitDirectionsPolyline,drivingOrWalkingPath="path=color:0x0000ffff|weight:4|enc:"+$scope.drivingOrWalkingDirectionsPolyline,commonUrl=staticMapsUrl+mapCenter+"&"+zoomLevel+"&"+mapSize+"&"+startMarker+"&"+endMarker;$("#img-out").show();var image1=document.getElementById("img-out");image1.setAttribute("crossorigin","anonymous"),image1.setAttribute("src",commonUrl+"&"+drivingOrWalkingPath),document.getElementById("img-out-2").setAttribute("src",commonUrl+"&"+transitPath)}},$scope.shareImage=function(){document.getElementById("meme-validation").innerText="",$rootScope.selectedTemplate?(document.getElementById("map-results").classList.add("done"),$scope.showImage=!0,scrollToElement("invisible-map-anchor")):document.getElementById("meme-validation").innerText="Select a meme template on the right hand side to create your meme"};var getBoundsCoveringBoth=function(bounds1,bounds2){return bounds1.extend(bounds2.getNorthEast()),bounds1.extend(bounds2.getSouthWest()),bounds1}}),app.factory("MapService",function(){return{getDirections:function(travelOptions,mode,callback){var directionsService=new google.maps.DirectionsService,start=new google.maps.LatLng(travelOptions.startLat,travelOptions.startLng),end=new google.maps.LatLng(travelOptions.destLat,travelOptions.destLng),request={origin:start,destination:end};switch(mode){case"driving":request.travelMode=google.maps.TravelMode.DRIVING;break;case"walking":request.travelMode=google.maps.TravelMode.WALKING;break;default:request.travelMode=google.maps.TravelMode.TRANSIT}directionsService.route(request,callback)}}});var app=angular.module("bus-meme");app.controller("MemeController",function($scope,$rootScope,$location,MemeFactory,$anchorScroll){function writeTextOnImage(context,text,x,y){for(var f=36;f>=0;f-=1)if(context.font="bold "+f+"pt Impact, Charcoal, sans-serif",context.measureText(text).width<canvas.width-10){context.fillText(text,x,y),context.strokeText(text,x,y);break}}MemeFactory.getMemeTemplates().then(function(response){$scope.memeTemplates=response.data,$rootScope.selectedTemplate="",$scope.memeTemplates=response.data}),$scope.setSelectedTemplate=function(template){document.getElementById("meme-validation").innerText="",$rootScope.selectedTemplate=template,$scope.renderMeme()},$scope.renderMeme=function(){var image=document.getElementById("img-out"),canvas=document.getElementById("canvas"),context=canvas.getContext("2d"),topText=$rootScope.selectedTemplate.firstLine,bottomText=$rootScope.selectedTemplate.secondLine;canvas.width=image.width,canvas.height=image.height,context.drawImage(image,0,0,canvas.width,canvas.height),context.textAlign="center",context.fillStyle="white",context.strokeStyle="black",context.lineWidth=2,writeTextOnImage(context,topText,canvas.width/2,70),writeTextOnImage(context,bottomText,canvas.width/2,canvas.height-30),$("#img-out").hide(),$rootScope.imageLink="",$rootScope.memeText=$rootScope.selectedTemplate.firstLine+" - "+$rootScope.selectedTemplate.secondLine}}),app.factory("MemeFactory",["$http",function($http){return{getMemeTemplates:function(){return $http.get("/getMemeTemplates")},saveImageDetails:function(imageDetails){return $http.post("/saveImage",{data:imageDetails})},getImages:function(){return $http.get("/getImages")},saveUserDetails:function(userDetails){return $http.post("/saveUser",{data:userDetails})}}}]);var app=angular.module("bus-meme");app.controller("TimeController",function($scope){function getSevenDays(){days=[];var date=new Date;days.push({label:"Today ("+weekdays[date.getDay()]+")",dateValue:new Date(date)});for(var i=0;6>i;i++)date.setDate(date.getDate()+1),days.push({label:getDateDisplayLabel(date),dateValue:new Date(date)});return days}function getHours(){for(var hours=[],i=1;12>=i;i++)hours.push(i);return hours}function getMinutes(){for(var minutes=[],i=0;12>i;i++){var thisMinute=5*i;60==thisMinute&&(thisMinute=0),minutes.push(twoDigits(thisMinute))}return minutes}function setSelectedTime(){var date=new Date,hour=date.getHours(),roundedMinute=5*Math.ceil(date.getMinutes()/5);60==roundedMinute&&(roundedMinute=0,hour++),$scope.selectedAmpm=$scope.ampms[0],hour>12&&(hour-=12,$scope.selectedAmpm=$scope.ampms[1]),$scope.selectedMinute=$scope.minutes[roundedMinute/5],$scope.selectedHour=$scope.hours[hour-1]}function twoDigits(digit){return 10>digit?"0"+digit.toString():digit.toString()}function getDateDisplayLabel(date){return weekdays[date.getDay()].substr(0,3)+" "+date.getDate()+" "+months[date.getMonth()]+" "+date.getFullYear()}function getWalkingOptions(){var walkingOptions=[{label:"Up to 100m",value:"100"},{label:"Up to 250m",value:"250"},{label:"Up to 500m",value:"500"},{label:"Up to 1km",value:"1000"},{label:"Up to 1.5km",value:"1500"},{label:"Up to 2km",value:"2000"},{label:"Up to 4km",value:"4000"}];return walkingOptions}var weekdays=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];$scope.ampms=["am","pm"],$scope.days=getSevenDays(),$scope.selectedDate=$scope.days[0],$scope.hours=getHours(),$scope.minutes=getMinutes(),$scope.walkingOptions=getWalkingOptions(),setSelectedTime(),$scope.timeOption="after",$scope.selectedMaxWalk=$scope.walkingOptions[4],$scope.getSelectedTime=function(){var hour=$scope.selectedHour;"pm"==$scope.selectedAmpm&&(hour+=12);var date=new Date($scope.selectedDate.dateValue.getFullYear(),$scope.selectedDate.dateValue.getMonth(),$scope.selectedDate.dateValue.getDate(),hour,$scope.selectedMinute,0,0);return date}});var app=angular.module("bus-meme");app.controller("GalleryController",function($scope,$location,MemeFactory){$scope.images=[],$scope.travelMode=["driving","walking"],MemeFactory.getImages().then(function(response){$scope.images=response.data}),$scope.showHomePage=function(){$location.path("")},$scope.formatDistance=function(distance){if(1e3>distance)return distance+"m";var distanceInKm=distance/1e3;return distanceInKm+"km"},$scope.formatTravelTime=function(time){var timeInMinutes=time/6e4;if(60>timeInMinutes)return timeInMinutes+" mins";var hours=(timeInMinutes/60).toFixed(0),minutesLeft=timeInMinutes-60*hours;return hours+" hrs "+minutesLeft+" mins"}}),app.filter("transportMode",function(){return function(images,transportMode){return transportMode&&images.length>0?images.filter(function(image){return image.otherMode===transportMode[0].toLowerCase()||image.otherMode===transportMode[1].toLowerCase()}):images}});var app=angular.module("bus-meme");app.controller("SocialMediaController",function($scope,$rootScope,$location,MemeFactory){function convertToMiliseconds(travelTime){var timeArray=travelTime.split(" ");return moment.duration({hours:timeArray.length>2?timeArray[0]:0,minutes:2===timeArray.length?timeArray[0]:timeArray[0]}).asMilliseconds()}function convertToMeters(distance){return Number(distance.replace(" km",""))*KM_TO_METER_FACTOR}function validEmail(email){return/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+$/.test(email)}function validUser(user){return user.fullName&&user.email?validEmail(user.email):void 0}var KM_TO_METER_FACTOR=1e3;$scope.user={},$scope.invalidUserInput=!1,$scope.downloadCanvas=function(){var canvas=document.getElementById("canvas");$rootScope.imageUrl=canvas.toDataURL("image/png");document.getElementById("dl")},$scope.saveImage=function(callback){if($rootScope.imageLink)callback($rootScope.imageLink);else{$scope.downloadCanvas();var imageDetails={imageUrl:$rootScope.imageUrl,otherMode:$scope.other.mode,otherModeTravelTime:convertToMiliseconds($scope.other.duration),otherModeTravelDistance:convertToMeters($scope.other.distance),publicModeTravelTime:convertToMiliseconds($scope["public"].duration),publicModeTravelDistance:convertToMeters($scope["public"].distance),user:$scope.user};MemeFactory.saveImageDetails(imageDetails).then(function(response){var baseUrl=$location.absUrl().replace("#/",""),imageLink=encodeURIComponent(response.data.imageLink);$rootScope.imageLink=baseUrl+"image/"+imageLink})}},$scope.facebookShare=function(){$scope.saveImage(function(imageLink){window.open("https://www.facebook.com/sharer/sharer.php?u="+imageLink+"&t="+$rootScope.memeText,"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600")})},$scope.instagramShare=function(){},$scope.twitterShare=function(){$scope.saveImage(function(imageLink){window.open("https://twitter.com/intent/tweet?text="+$rootScope.memeText+"&url="+imageLink,"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600")})},$scope.saveUserDetails=function(){$scope.invalidUserInput=!validUser($scope.user),$scope.invalidUserInput||MemeFactory.saveUserDetails($scope.user).then(function(response){console.log(response.data)})}});